<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Viajeros - Delf√≠n Check-in</title>
    <meta name="description" content="Formulario de registro compatible con el Ministerio del Interior de Espa√±a">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .form-input { 
            width: 100%; 
            padding: 0.5rem 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
        }
        .form-input:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        }
        .btn-primary { 
            background-color: #2563eb; 
            color: white; 
            padding: 0.75rem 1rem; 
            border-radius: 0.375rem; 
            font-weight: 500; 
        }
        .btn-primary:hover { 
            background-color: #1d4ed8; 
        }
        .btn-primary:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        .success-message {
            display: none;
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .error-message {
            display: none;
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .language-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            color: #374151;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .language-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .language-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header con selector de idioma -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="text-3xl mr-3">üê¨</div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" data-i18n="header.title">Delf√≠n Check-in</h1>
                        <p class="text-sm text-gray-600" data-i18n="header.subtitle">Sistema de Registro de Viajeros</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="language-btn active" data-lang="es" onclick="changeLanguage('es')">
                        üá™üá∏ Espa√±ol
                    </button>
                    <button class="language-btn" data-lang="en" onclick="changeLanguage('en')">
                        üá¨üáß English
                    </button>
                    <button class="language-btn" data-lang="fr" onclick="changeLanguage('fr')">
                        üá´üá∑ Fran√ßais
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- T√≠tulo principal centrado -->
        <div class="text-center mb-8">
            <div class="text-4xl mb-4">üê¨</div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="main.title">
                Registro de parte de viajero
            </h2>
            <p class="text-lg text-gray-600" data-i18n="main.subtitle">
                Compatible con alta en el Ministerio del Interior de Espa√±a
            </p>
            <p class="text-sm text-gray-500 mt-2" data-i18n="main.required">
                Complete todos los campos obligatorios marcados con *
            </p>
        </div>

        <!-- Formulario funcional -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <form id="guestRegistrationForm" class="space-y-8">
                <!-- Secci√≥n Contrato -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="h-5 w-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span data-i18n="contract.title">Contrato</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Campos ocultos con valores autom√°ticos -->
                        <input type="hidden" name="codigoEstablecimiento" value="0000256653" />
                        <input type="hidden" name="referencia" value="0000146967" />
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.contractDate">
                                Fecha contrato (AAAA-MM-DD) *
                            </label>
                            <input
                                type="date"
                                name="fechaContrato"
                                required
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.checkIn">
                                Entrada (AAAA-MM-DDThh:mm:ss) *
                            </label>
                            <input
                                type="datetime-local"
                                name="fechaEntrada"
                                required
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.checkOut">
                                Salida (AAAA-MM-DDThh:mm:ss) *
                            </label>
                            <input
                                type="datetime-local"
                                name="fechaSalida"
                                required
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.rooms">
                                N¬∫ habitaciones
                            </label>
                            <input
                                type="number"
                                name="numHabitaciones"
                                min="1"
                                value="1"
                                class="form-input"
                            />
                        </div>
                        
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="internet"
                                name="internet"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            />
                            <label for="internet" class="ml-2 block text-sm text-gray-900" data-i18n="contract.internet">
                                Internet
                            </label>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.paymentType">
                                Tipo de pago *
                            </label>
                            <select
                                name="tipoPago"
                                required
                                class="form-input"
                            >
                                <option value="EFECT" data-i18n="contract.payment.cash">Efectivo</option>
                                <option value="TARJT" data-i18n="contract.payment.card">Tarjeta</option>
                                <option value="PLATF" data-i18n="contract.payment.platform">Plataforma</option>
                                <option value="TRANS" data-i18n="contract.payment.transfer">Transferencia</option>
                                <option value="MOVIL" data-i18n="contract.payment.mobile">M√≥vil</option>
                                <option value="TREG" data-i18n="contract.payment.check">Cheque</option>
                                <option value="DESTI" data-i18n="contract.payment.destination">Destino</option>
                                <option value="OTRO" data-i18n="contract.payment.other">Otro</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.paymentDate">
                                Fecha de pago (AAAA-MM-DD)
                            </label>
                            <input
                                type="date"
                                name="fechaPago"
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.paymentMethod">
                                Medio de pago
                            </label>
                            <input
                                type="text"
                                name="medioPago"
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.cardholder">
                                Titular
                            </label>
                            <input
                                type="text"
                                name="titular"
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.expiry">
                                Caducidad (MM/AAAA)
                            </label>
                            <input
                                type="text"
                                name="caducidadTarjeta"
                                placeholder="MM/AAAA"
                                class="form-input"
                            />
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n Viajeros -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="h-5 w-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span data-i18n="travelers.title">Viajeros</span>
                    </h3>
                    
                    <div class="border rounded-lg p-6 mb-4 bg-gray-50">
                        <h4 class="font-medium text-gray-900 mb-4" data-i18n="travelers.traveler1">
                            Viajero 1
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.firstName">
                                    Nombre *
                                </label>
                                <input
                                    type="text"
                                    name="nombre"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.firstSurname">
                                    Primer apellido *
                                </label>
                                <input
                                    type="text"
                                    name="apellido1"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.secondSurname">
                                    Segundo apellido
                                </label>
                                <input
                                    type="text"
                                    name="apellido2"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.birthDate">
                                    Fecha nacimiento (AAAA-MM-DD) *
                                </label>
                                <input
                                    type="date"
                                    name="fechaNacimiento"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.documentType">
                                    Tipo documento
                                </label>
                                <select
                                    name="tipoDocumento"
                                    class="form-input"
                                >
                                    <option value="NIF" data-i18n="travelers.documents.dni">DNI</option>
                                    <option value="NIE" data-i18n="travelers.documents.nie">NIE</option>
                                    <option value="PAS" selected data-i18n="travelers.documents.passport">Pasaporte</option>
                                    <option value="OTRO" data-i18n="travelers.documents.other">Otro</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.documentNumber">
                                    N√∫mero documento
                                </label>
                                <input
                                    type="text"
                                    name="numeroDocumento"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.nationality">
                                    Nacionalidad (ISO3)
                                </label>
                                <input
                                    type="text"
                                    name="nacionalidad"
                                    value="ESP"
                                    class="form-input"
                                    maxlength="3"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.gender">
                                    Sexo
                                </label>
                                <select
                                    name="sexo"
                                    class="form-input"
                                >
                                    <option value="H" selected data-i18n="travelers.gender.male">Hombre</option>
                                    <option value="M" data-i18n="travelers.gender.female">Mujer</option>
                                    <option value="O" data-i18n="travelers.gender.other">Otro</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.phone">
                                    Tel√©fono
                                </label>
                                <input
                                    type="tel"
                                    name="telefono"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.email">
                                    Correo electr√≥nico
                                </label>
                                <input
                                    type="email"
                                    name="correo"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.address">
                                    Direcci√≥n *
                                </label>
                                <input
                                    type="text"
                                    name="direccion"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.postalCode">
                                    C√≥digo postal *
                                </label>
                                <input
                                    type="text"
                                    name="codigoPostal"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.country">
                                    Pa√≠s (ISO3) *
                                </label>
                                <select
                                    name="pais"
                                    class="form-input"
                                >
                                    <option value="ESP" selected data-i18n="travelers.countries.spain">Espa√±a</option>
                                    <option value="FRA" data-i18n="travelers.countries.france">Francia</option>
                                    <option value="GBR" data-i18n="travelers.countries.uk">Reino Unido</option>
                                    <option value="DEU" data-i18n="travelers.countries.germany">Alemania</option>
                                    <option value="ITA" data-i18n="travelers.countries.italy">Italia</option>
                                    <option value="PRT" data-i18n="travelers.countries.portugal">Portugal</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.municipalityCode">
                                    C√≥digo municipio INE (5) *
                                </label>
                                <input
                                    type="text"
                                    name="codigoMunicipio"
                                    required
                                    class="form-input"
                                    maxlength="5"
                                    placeholder="29045"
                                />
                                <p class="text-xs text-gray-500 mt-1" data-i18n="travelers.municipalityHelp">
                                    Ejemplo: 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensajes de estado -->
                <div id="successMessage" class="success-message">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">
                                <strong data-i18n="messages.success.title">¬°Registro enviado correctamente!</strong> 
                                <span data-i18n="messages.success.body">Los datos han sido enviados al dashboard del administrador.</span>
                            </p>
                            <p class="text-sm mt-1" data-i18n="messages.success.redirect">
                                Ser√° redirigido al dashboard en unos segundos...
                            </p>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="error-message">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">
                                <strong data-i18n="messages.error.title">Error al enviar el registro.</strong> 
                                <span id="errorDetails" data-i18n="messages.error.body">Por favor, int√©ntelo de nuevo.</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Panel de depuraci√≥n (solo visible tras error) -->
                <div id="debugPanel" class="mt-4 hidden">
                  <details open class="bg-gray-100 border border-gray-300 rounded p-3">
                    <summary class="cursor-pointer font-medium text-gray-800">Detalles t√©cnicos</summary>
                    <div class="mt-2 text-xs text-gray-700 space-y-2">
                      <div>
                        <div class="font-semibold">Respuesta del servidor</div>
                        <pre id="serverErrorJson" class="whitespace-pre-wrap break-all bg-white border p-2 rounded"></pre>
                      </div>
                      <div>
                        <div class="font-semibold">Payload enviado</div>
                        <pre id="sentPayloadJson" class="whitespace-pre-wrap break-all bg-white border p-2 rounded"></pre>
                      </div>
                    </div>
                  </details>
                </div>

                <!-- Bot√≥n de env√≠o -->
                <div class="pt-6">
                    <button
                        type="submit"
                        id="submitButton"
                        class="btn-primary w-full flex items-center justify-center text-lg"
                    >
                        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span data-i18n="submit.button">Enviar Registro</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Sistema de traducciones
        const translations = {
            es: {
                "header.title": "Delf√≠n Check-in",
                "header.subtitle": "Sistema de Registro de Viajeros",
                "main.title": "Registro de parte de viajero",
                "main.subtitle": "Compatible con alta en el Ministerio del Interior de Espa√±a",
                "main.required": "Complete todos los campos obligatorios marcados con *",
                "contract.title": "Contrato",
                "contract.establishmentCode": "C√≥digo establecimiento *",
                "contract.reference": "Referencia *",
                "contract.contractDate": "Fecha contrato (AAAA-MM-DD) *",
                "contract.checkIn": "Entrada (AAAA-MM-DDThh:mm:ss) *",
                "contract.checkOut": "Salida (AAAA-MM-DDThh:mm:ss) *",
                "contract.rooms": "N¬∫ habitaciones",
                "contract.internet": "Internet",
                "contract.paymentType": "Tipo de pago *",
                "contract.payment.cash": "Efectivo",
                "contract.payment.card": "Tarjeta",
                "contract.payment.platform": "Plataforma",
                "contract.payment.transfer": "Transferencia",
                "contract.payment.mobile": "M√≥vil",
                "contract.payment.check": "Cheque",
                "contract.payment.destination": "Destino",
                "contract.payment.other": "Otro",
                "contract.paymentDate": "Fecha de pago (AAAA-MM-DD)",
                "contract.paymentMethod": "Medio de pago",
                "contract.cardholder": "Titular",
                "contract.expiry": "Caducidad (MM/AAAA)",
                "travelers.title": "Viajeros",
                "travelers.traveler1": "Viajero 1",
                "travelers.firstName": "Nombre *",
                "travelers.firstSurname": "Primer apellido *",
                "travelers.secondSurname": "Segundo apellido",
                "travelers.birthDate": "Fecha nacimiento (AAAA-MM-DD) *",
                "travelers.documentType": "Tipo documento",
                "travelers.documents.dni": "DNI",
                "travelers.documents.nie": "NIE",
                "travelers.documents.passport": "Pasaporte",
                "travelers.documents.other": "Otro",
                "travelers.documentNumber": "N√∫mero documento",
                "travelers.nationality": "Nacionalidad (ISO3)",
                "travelers.gender": "Sexo",
                "travelers.gender.male": "Hombre",
                "travelers.gender.female": "Mujer",
                "travelers.gender.other": "Otro",
                "travelers.phone": "Tel√©fono",
                "travelers.email": "Correo electr√≥nico",
                "travelers.address": "Direcci√≥n *",
                "travelers.postalCode": "C√≥digo postal *",
                "travelers.country": "Pa√≠s (ISO3) *",
                "travelers.countries.spain": "Espa√±a",
                "travelers.countries.france": "Francia",
                "travelers.countries.uk": "Reino Unido",
                "travelers.countries.germany": "Alemania",
                "travelers.countries.italy": "Italia",
                "travelers.countries.portugal": "Portugal",
                "travelers.municipalityCode": "C√≥digo municipio INE (5) *",
                "travelers.municipalityHelp": "Ejemplo: 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)",
                "messages.success.title": "¬°Registro enviado correctamente!",
                "messages.success.body": "Los datos han sido enviados al dashboard del administrador.",
                "messages.success.redirect": "Ser√° redirigido al dashboard en unos segundos...",
                "messages.error.title": "Error al enviar el registro.",
                "messages.error.body": "Por favor, int√©ntelo de nuevo.",
                "submit.button": "Enviar Registro",
                "submit.sending": "Enviando..."
            },
            en: {
                "header.title": "Delf√≠n Check-in",
                "header.subtitle": "Guest Registration System",
                "main.title": "Traveler Registration Form",
                "main.subtitle": "Compatible with Spanish Ministry of Interior registration",
                "main.required": "Complete all required fields marked with *",
                "contract.title": "Contract",
                "contract.establishmentCode": "Establishment code *",
                "contract.reference": "Reference *",
                "contract.contractDate": "Contract date (YYYY-MM-DD) *",
                "contract.checkIn": "Check-in (YYYY-MM-DDThh:mm:ss) *",
                "contract.checkOut": "Check-out (YYYY-MM-DDThh:mm:ss) *",
                "contract.rooms": "Number of rooms",
                "contract.internet": "Internet",
                "contract.paymentType": "Payment type *",
                "contract.payment.cash": "Cash",
                "contract.payment.card": "Card",
                "contract.payment.platform": "Platform",
                "contract.payment.transfer": "Transfer",
                "contract.payment.mobile": "Mobile",
                "contract.payment.check": "Check",
                "contract.payment.destination": "Destination",
                "contract.payment.other": "Other",
                "contract.paymentDate": "Payment date (YYYY-MM-DD)",
                "contract.paymentMethod": "Payment method",
                "contract.cardholder": "Cardholder",
                "contract.expiry": "Expiry (MM/YYYY)",
                "travelers.title": "Travelers",
                "travelers.traveler1": "Traveler 1",
                "travelers.firstName": "First name *",
                "travelers.firstSurname": "First surname *",
                "travelers.secondSurname": "Second surname",
                "travelers.birthDate": "Birth date (YYYY-MM-DD) *",
                "travelers.documentType": "Document type",
                "travelers.documents.dni": "DNI",
                "travelers.documents.nie": "NIE",
                "travelers.documents.passport": "Passport",
                "travelers.documents.other": "Other",
                "travelers.documentNumber": "Document number",
                "travelers.nationality": "Nationality (ISO3)",
                "travelers.gender": "Gender",
                "travelers.gender.male": "Male",
                "travelers.gender.female": "Female",
                "travelers.gender.other": "Other",
                "travelers.phone": "Phone",
                "travelers.email": "Email",
                "travelers.address": "Address *",
                "travelers.postalCode": "Postal code *",
                "travelers.country": "Country (ISO3) *",
                "travelers.countries.spain": "Spain",
                "travelers.countries.france": "France",
                "travelers.countries.uk": "United Kingdom",
                "travelers.countries.germany": "Germany",
                "travelers.countries.italy": "Italy",
                "travelers.countries.portugal": "Portugal",
                "travelers.municipalityCode": "Municipality INE code (5) *",
                "travelers.municipalityHelp": "Example: 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)",
                "messages.success.title": "Registration sent successfully!",
                "messages.success.body": "Data has been sent to the admin dashboard.",
                "messages.success.redirect": "You will be redirected to the dashboard in a few seconds...",
                "messages.error.title": "Error sending registration.",
                "messages.error.body": "Please try again.",
                "submit.button": "Send Registration",
                "submit.sending": "Sending..."
            },
            fr: {
                "header.title": "Delf√≠n Check-in",
                "header.subtitle": "Syst√®me d'Enregistrement des Voyageurs",
                "main.title": "Formulaire d'Enregistrement des Voyageurs",
                "main.subtitle": "Compatible avec l'enregistrement du Minist√®re de l'Int√©rieur espagnol",
                "main.required": "Remplissez tous les champs obligatoires marqu√©s avec *",
                "contract.title": "Contrat",
                "contract.establishmentCode": "Code √©tablissement *",
                "contract.reference": "R√©f√©rence *",
                "contract.contractDate": "Date contrat (AAAA-MM-JJ) *",
                "contract.checkIn": "Arriv√©e (AAAA-MM-JJThh:mm:ss) *",
                "contract.checkOut": "D√©part (AAAA-MM-JJThh:mm:ss) *",
                "contract.rooms": "Nombre de chambres",
                "contract.internet": "Internet",
                "contract.paymentType": "Type de paiement *",
                "contract.payment.cash": "Esp√®ces",
                "contract.payment.card": "Carte",
                "contract.payment.platform": "Plateforme",
                "contract.payment.transfer": "Virement",
                "contract.payment.mobile": "Mobile",
                "contract.payment.check": "Ch√®que",
                "contract.payment.destination": "Destination",
                "contract.payment.other": "Autre",
                "contract.paymentDate": "Date de paiement (AAAA-MM-JJ)",
                "contract.paymentMethod": "Moyen de paiement",
                "contract.cardholder": "Titulaire",
                "contract.expiry": "Expiration (MM/AAAA)",
                "travelers.title": "Voyageurs",
                "travelers.traveler1": "Voyageur 1",
                "travelers.firstName": "Pr√©nom *",
                "travelers.firstSurname": "Premier nom de famille *",
                "travelers.secondSurname": "Deuxi√®me nom de famille",
                "travelers.birthDate": "Date de naissance (AAAA-MM-JJ) *",
                "travelers.documentType": "Type de document",
                "travelers.documents.dni": "DNI",
                "travelers.documents.nie": "NIE",
                "travelers.documents.passport": "Passeport",
                "travelers.documents.other": "Autre",
                "travelers.documentNumber": "Num√©ro de document",
                "travelers.nationality": "Nationalit√© (ISO3)",
                "travelers.gender": "Sexe",
                "travelers.gender.male": "Homme",
                "travelers.gender.female": "Femme",
                "travelers.gender.other": "Autre",
                "travelers.phone": "T√©l√©phone",
                "travelers.email": "Email",
                "travelers.address": "Adresse *",
                "travelers.postalCode": "Code postal *",
                "travelers.country": "Pays (ISO3) *",
                "travelers.countries.spain": "Espagne",
                "travelers.countries.france": "France",
                "travelers.countries.uk": "Royaume-Uni",
                "travelers.countries.germany": "Allemagne",
                "travelers.countries.italy": "Italie",
                "travelers.countries.portugal": "Portugal",
                "travelers.municipalityCode": "Code municipal INE (5) *",
                "travelers.municipalityHelp": "Exemple: 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)",
                "messages.success.title": "Enregistrement envoy√© avec succ√®s !",
                "messages.success.body": "Les donn√©es ont √©t√© envoy√©es au tableau de bord administrateur.",
                "messages.success.redirect": "Vous serez redirig√© vers le tableau de bord dans quelques secondes...",
                "messages.error.title": "Erreur lors de l'envoi de l'enregistrement.",
                "messages.error.body": "Veuillez r√©essayer.",
                "submit.button": "Envoyer l'Enregistrement",
                "submit.sending": "Envoi en cours..."
            }
        };

        // Funci√≥n para cambiar idioma
        function changeLanguage(lang) {
            // Actualizar botones de idioma
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
            
            // Cambiar atributo lang del HTML
            document.documentElement.lang = lang;
            
            // Aplicar traducciones
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Guardar preferencia en localStorage
            localStorage.setItem('preferredLanguage', lang);
        }

        // Funci√≥n para inicializar idioma
        function initializeLanguage() {
            const savedLang = localStorage.getItem('preferredLanguage') || 'es';
            changeLanguage(savedLang);
        }

        // Inicializar idioma al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', initializeLanguage);

        // Helpers: limpiar payload y validaciones m√≠nimas
        function cleanEmpty(value) {
            if (Array.isArray(value)) {
                const arr = value.map(cleanEmpty).filter(v => {
                    if (v == null) return false;
                    if (typeof v === 'string' && v.trim() === '') return false;
                    if (typeof v === 'object' && !Array.isArray(v) && Object.keys(v).length === 0) return false;
                    return true;
                });
                return arr;
            }
            if (value && typeof value === 'object') {
                const out = {};
                for (const [k, v] of Object.entries(value)) {
                    const c = cleanEmpty(v);
                    if (c == null) continue;
                    if (typeof c === 'string' && c.trim() === '') continue;
                    if (typeof c === 'object' && !Array.isArray(c) && Object.keys(c).length === 0) continue;
                    out[k] = c;
                }
                return out;
            }
            return value;
        }

        function isFiveDigits(str) {
            return /^\d{5}$/.test(String(str || ''));
        }

        function ensureSeconds(dateStr) {
            if (!dateStr) return '';
            // Si ya tiene segundos, devolverlo
            if (/:\d{2}$/.test(dateStr)) return dateStr;
            // Si tiene formato YYYY-MM-DDThh:mm, a√±adir :00
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dateStr)) {
                return dateStr + ':00';
            }
            return dateStr;
        }

        function pad5(str) {
            const digits = String(str || '').replace(/\D/g, '');
            return digits.padStart(5, '0').slice(0, 5);
        }

        function upper3(str) {
            return String(str || '').toUpperCase().slice(0, 3);
        }

        document.getElementById('guestRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            // Ocultar mensajes anteriores
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Deshabilitar bot√≥n y mostrar estado de env√≠o
            submitButton.disabled = true;
            const currentLang = document.documentElement.lang || 'es';
            const sendingText = translations[currentLang]['submit.sending'] || 'Enviando...';
            submitButton.innerHTML = `
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div>
                ${sendingText}
            `;
            
            let __lastPayload = '';
            try {
                // Validaciones m√≠nimas requeridas por el MIR
                const formData = new FormData(e.target);
                
                // Normalizar y validar fechas
                const fechaEntrada = ensureSeconds(formData.get('fechaEntrada'));
                const fechaSalida = ensureSeconds(formData.get('fechaSalida'));
                
                if (!fechaEntrada || !fechaSalida) {
                    const errorDetails = document.getElementById('errorDetails');
                    if (errorDetails) errorDetails.textContent = 'Fechas de entrada y salida son obligatorias';
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }
                
                // Normalizar c√≥digos postales y municipio
                const codigoPostal = pad5(formData.get('codigoPostal'));
                const codigoMunicipio = pad5(formData.get('codigoMunicipio'));
                
                if (!isFiveDigits(codigoPostal)) {
                    const errorDetails = document.getElementById('errorDetails');
                    if (errorDetails) errorDetails.textContent = 'C√≥digo postal debe tener 5 d√≠gitos';
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }
                if (!isFiveDigits(codigoMunicipio)) {
                    const errorDetails = document.getElementById('errorDetails');
                    if (errorDetails) errorDetails.textContent = 'C√≥digo INE del municipio debe tener 5 d√≠gitos';
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }
                
                // Validaci√≥n de documento
                const tipoDocumento = formData.get('tipoDocumento');
                const numeroDocumento = formData.get('numeroDocumento');
                if (tipoDocumento && !numeroDocumento) {
                    const errorDetails = document.getElementById('errorDetails');
                    if (errorDetails) errorDetails.textContent = 'Si selecciona tipo de documento, debe proporcionar el n√∫mero';
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }

                // Construcci√≥n del payload cumpliendo esquema y sin strings vac√≠os
                const pago = {
                    tipoPago: formData.get('tipoPago')
                };
                if (formData.get('fechaPago')) pago.fechaPago = formData.get('fechaPago');
                if (formData.get('medioPago')) pago.medioPago = formData.get('medioPago');
                if (formData.get('titular')) pago.titular = formData.get('titular');
                if (formData.get('caducidadTarjeta')) pago.caducidadTarjeta = formData.get('caducidadTarjeta');

                const persona = {
                    rol: 'VI',
                    nombre: formData.get('nombre'),
                    apellido1: formData.get('apellido1'),
                    apellido2: formData.get('apellido2') || undefined,
                    tipoDocumento: tipoDocumento || undefined,
                    numeroDocumento: numeroDocumento || undefined,
                    // soporteDocumento SOLO si aplica (no enviar si vac√≠o)
                    fechaNacimiento: formData.get('fechaNacimiento'),
                    nacionalidad: upper3(formData.get('nacionalidad')) || undefined,
                    sexo: formData.get('sexo') || undefined,
                    contacto: {
                        telefono: formData.get('telefono') || undefined,
                        telefono2: undefined,
                        correo: formData.get('correo') || undefined
                    },
                    direccion: {
                        direccion: formData.get('direccion'),
                        direccionComplementaria: undefined,
                        codigoPostal: codigoPostal,
                        pais: upper3(formData.get('pais')),
                        codigoMunicipio: codigoMunicipio || undefined,
                        nombreMunicipio: undefined
                    }
                };

                const data = {
                    codigoEstablecimiento: formData.get('codigoEstablecimiento'),
                    comunicaciones: [
                        {
                            contrato: {
                                referencia: formData.get('referencia'),
                                fechaContrato: formData.get('fechaContrato'),
                                fechaEntrada: fechaEntrada,
                                fechaSalida: fechaSalida,
                                numPersonas: 1,
                                numHabitaciones: parseInt(formData.get('numHabitaciones')) || 1,
                                internet: formData.get('internet') === 'on',
                                pago
                            },
                            personas: [persona]
                        }
                    ]
                };
                
                // Limpiar payload y mostrar para debug
                const cleanData = cleanEmpty(data);
                console.log('üì§ Payload limpio enviado:', JSON.stringify(cleanData, null, 2));
                // Guardar para panel de depuraci√≥n si hay error
                __lastPayload = JSON.stringify(cleanData, null, 2);
                
                // Enviar datos a la API de Vercel
                const response = await fetch('https://admin.delfincheckin.com/api/public/guest-registration', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cleanData),
                });
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    // Panel de depuraci√≥n: obtener respuesta y payload
                    let serverJsonStr = '';
                    try {
                        const errorData = await response.json();
                        if (errorData && (errorData.error || errorData.message || errorData.details)) {
                            errorMessage = errorData.error || errorData.message || JSON.stringify(errorData.details);
                        }
                        serverJsonStr = JSON.stringify(errorData, null, 2);
                    } catch (_) {
                        // fallback a texto plano
                        try { serverJsonStr = await response.text(); } catch(__) {}
                    }
                    // Poblar panel de depuraci√≥n
                    const debugPanel = document.getElementById('debugPanel');
                    if (debugPanel) {
                        debugPanel.classList.remove('hidden');
                        const serverErr = document.getElementById('serverErrorJson');
                        const sentPayload = document.getElementById('sentPayloadJson');
                        if (serverErr) serverErr.textContent = serverJsonStr || '(sin cuerpo)';
                        if (sentPayload) sentPayload.textContent = __lastPayload || '(sin payload)';
                    }
                    throw new Error(errorMessage);
                }
                
                // Mostrar mensaje de √©xito
                successMessage.style.display = 'block';
                
                // Redirigir al dashboard despu√©s de 3 segundos
                setTimeout(() => {
                    window.open('https://admin.delfincheckin.com/guest-registrations-dashboard', '_blank');
                }, 3000);
                
            } catch (error) {
                console.error('Error:', error);
                const errorDetails = document.getElementById('errorDetails');
                if (errorDetails) {
                    let msg = error && error.message ? String(error.message) : 'Error desconocido';
                    // Normaliza algunos mensajes comunes del backend
                    if (/invalid|inv√°lid/i.test(msg)) {
                        msg = msg + ' ‚Äî Pista: revisa formato de fechas (MIR), que CP y municipio sean 5 d√≠gitos y que el documento sea coherente con el tipo.';
                    }
                    errorDetails.textContent = msg;
                }
                errorMessage.style.display = 'block';
            } finally {
                // Panel de depuraci√≥n: ocultar si √©xito/pr√≥ximo intento
                const debugPanel = document.getElementById('debugPanel');
                if (debugPanel) debugPanel.classList.add('hidden');
                // Restaurar bot√≥n
                submitButton.disabled = false;
                const currentLang = document.documentElement.lang || 'es';
                const buttonText = translations[currentLang]['submit.button'] || 'Enviar Registro';
                submitButton.innerHTML = `
                    <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    ${buttonText}
                `;
            }
        });
    </script>
</body>
</html>
