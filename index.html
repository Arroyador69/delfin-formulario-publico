<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Viajeros - Delf√≠n Check-in</title>
    <meta name="description" content="Formulario de registro compatible con el Ministerio del Interior de Espa√±a">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .form-input { 
            width: 100%; 
            padding: 0.5rem 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
        }
        .form-input:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        }
        .btn-primary { 
            background-color: #2563eb; 
            color: white; 
            padding: 0.75rem 1rem; 
            border-radius: 0.375rem; 
            font-weight: 500; 
        }
        .btn-primary:hover { 
            background-color: #1d4ed8; 
        }
        .btn-primary:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        .success-message {
            display: none;
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .error-message {
            display: none;
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .language-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            color: #374151;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .language-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .language-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header con selector de idioma -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="text-3xl mr-3">üê¨</div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" data-i18n="header.title">Delf√≠n Check-in</h1>
                        <p class="text-sm text-gray-600" data-i18n="header.subtitle">Sistema de Registro de Viajeros</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="language-btn active" data-lang="es" onclick="changeLanguage('es')">
                        üá™üá∏ Espa√±ol
                    </button>
                    <button class="language-btn" data-lang="en" onclick="changeLanguage('en')">
                        üá¨üáß English
                    </button>
                    <button class="language-btn" data-lang="fr" onclick="changeLanguage('fr')">
                        üá´üá∑ Fran√ßais
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- T√≠tulo principal centrado -->
        <div class="text-center mb-8">
            <div class="text-4xl mb-4">üê¨</div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="main.title">
                Registro de parte de viajero
            </h2>
            <p class="text-lg text-gray-600" data-i18n="main.subtitle">
                Compatible con alta en el Ministerio del Interior de Espa√±a
            </p>
            <p class="text-sm text-gray-500 mt-2" data-i18n="main.required">
                Complete todos los campos obligatorios marcados con *
            </p>
            
            <!-- Aviso sobre file:// -->
            <div id="fileProtocolWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4 max-w-2xl mx-auto">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">
                            ‚ö†Ô∏è Aviso importante sobre el env√≠o del formulario
                        </h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p><strong>Si abriste esta p√°gina como archivo (file://...), el formulario NO funcionar√°</strong> debido a restricciones de seguridad del navegador (CORS).</p>
                            <p class="mt-1">Para que funcione correctamente, debes acceder a trav√©s de:</p>
                            <ul class="mt-1 list-disc list-inside">
                                <li>Una URL HTTPS (https://...)</li>
                                <li>Un servidor local (http://localhost:...)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario funcional -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <form id="guestRegistrationForm" class="space-y-8">
                <!-- Secci√≥n Contrato -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="h-5 w-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span data-i18n="contract.title">Contrato</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Campos ocultos con valores autom√°ticos -->
                        <input type="hidden" name="codigoEstablecimiento" value="0000256653" />
                        <input type="hidden" name="referencia" value="0000146967" />
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.contractDate">
                                Fecha contrato (AAAA-MM-DD) *
                            </label>
                            <input
                                type="date"
                                name="fechaContrato"
                                required
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.checkIn">
                                Entrada (AAAA-MM-DDThh:mm:ss) *
                            </label>
                            <input
                                type="datetime-local"
                                name="fechaEntrada"
                                required
                                class="form-input"
                                step="1"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.checkOut">
                                Salida (AAAA-MM-DDThh:mm:ss) *
                            </label>
                            <input
                                type="datetime-local"
                                name="fechaSalida"
                                required
                                class="form-input"
                                step="1"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.rooms">
                                N¬∫ habitaciones
                            </label>
                            <input
                                type="number"
                                name="numHabitaciones"
                                min="1"
                                value="1"
                                class="form-input"
                            />
                        </div>
                        
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="internet"
                                name="internet"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            />
                            <label for="internet" class="ml-2 block text-sm text-gray-900" data-i18n="contract.internet">
                                Internet
                            </label>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.paymentType">
                                Tipo de pago *
                            </label>
                            <select
                                name="tipoPago"
                                required
                                class="form-input"
                            >
                                <option value="EFECT" data-i18n="contract.payment.cash">Efectivo</option>
                                <option value="TARJT" data-i18n="contract.payment.card">Tarjeta</option>
                                <option value="PLATF" data-i18n="contract.payment.platform">Plataforma</option>
                                <option value="TRANS" data-i18n="contract.payment.transfer">Transferencia</option>
                                <option value="MOVIL" data-i18n="contract.payment.mobile">M√≥vil</option>
                                <option value="TREG" data-i18n="contract.payment.check">Cheque</option>
                                <option value="DESTI" data-i18n="contract.payment.destination">Destino</option>
                                <option value="OTRO" data-i18n="contract.payment.other">Otro</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.paymentDate">
                                Fecha de pago (AAAA-MM-DD)
                            </label>
                            <input
                                type="date"
                                name="fechaPago"
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.paymentMethod">
                                Medio de pago
                            </label>
                            <input
                                type="text"
                                name="medioPago"
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.cardholder">
                                Titular
                            </label>
                            <input
                                type="text"
                                name="titular"
                                class="form-input"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="contract.expiry">
                                Caducidad (MM/AAAA)
                            </label>
                            <input
                                type="text"
                                name="caducidadTarjeta"
                                placeholder="MM/AAAA"
                                class="form-input"
                            />
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n Viajeros -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="h-5 w-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span data-i18n="travelers.title">Viajeros</span>
                    </h3>
                    
                    <div class="border rounded-lg p-6 mb-4 bg-gray-50">
                        <h4 class="font-medium text-gray-900 mb-4" data-i18n="travelers.traveler1">
                            Viajero 1
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.firstName">
                                    Nombre *
                                </label>
                                <input
                                    type="text"
                                    name="nombre"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.firstSurname">
                                    Primer apellido *
                                </label>
                                <input
                                    type="text"
                                    name="apellido1"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.secondSurname">
                                    Segundo apellido
                                </label>
                                <input
                                    type="text"
                                    name="apellido2"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.birthDate">
                                    Fecha nacimiento (AAAA-MM-DD) *
                                </label>
                                <input
                                    type="date"
                                    name="fechaNacimiento"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.documentType">
                                    Tipo documento
                                </label>
                                <select
                                    name="tipoDocumento"
                                    class="form-input"
                                >
                                    <option value="NIF" data-i18n="travelers.documents.dni">DNI</option>
                                    <option value="NIE" data-i18n="travelers.documents.nie">NIE</option>
                                    <option value="PAS" selected data-i18n="travelers.documents.passport">Pasaporte</option>
                                    <option value="OTRO" data-i18n="travelers.documents.other">Otro</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.documentNumber">
                                    N√∫mero documento
                                </label>
                                <input
                                    type="text"
                                    name="numeroDocumento"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.nationality">
                                    Nacionalidad (ISO3)
                                </label>
                                <input
                                    type="text"
                                    name="nacionalidad"
                                    value="ESP"
                                    class="form-input"
                                    maxlength="3"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.gender">
                                    Sexo
                                </label>
                                <select
                                    name="sexo"
                                    class="form-input"
                                >
                                    <option value="H" selected data-i18n="travelers.gender.male">Hombre</option>
                                    <option value="M" data-i18n="travelers.gender.female">Mujer</option>
                                    <option value="O" data-i18n="travelers.gender.other">Otro</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.phone">
                                    Tel√©fono
                                </label>
                                <input
                                    type="tel"
                                    name="telefono"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.email">
                                    Correo electr√≥nico
                                </label>
                                <input
                                    type="email"
                                    name="correo"
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.address">
                                    Direcci√≥n *
                                </label>
                                <input
                                    type="text"
                                    name="direccion"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.postalCode">
                                    C√≥digo postal *
                                </label>
                                <input
                                    type="text"
                                    name="codigoPostal"
                                    required
                                    class="form-input"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.country">
                                    Pa√≠s (ISO3) *
                                </label>
                                <select
                                    name="pais"
                                    class="form-input"
                                >
                                    <option value="ESP" selected data-i18n="travelers.countries.spain">Espa√±a</option>
                                    <option value="FRA" data-i18n="travelers.countries.france">Francia</option>
                                    <option value="GBR" data-i18n="travelers.countries.uk">Reino Unido</option>
                                    <option value="DEU" data-i18n="travelers.countries.germany">Alemania</option>
                                    <option value="ITA" data-i18n="travelers.countries.italy">Italia</option>
                                    <option value="PRT" data-i18n="travelers.countries.portugal">Portugal</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="travelers.municipalityCode">
                                    C√≥digo municipio INE (5) *
                                </label>
                                <input
                                    type="text"
                                    name="codigoMunicipio"
                                    required
                                    class="form-input"
                                    maxlength="5"
                                    placeholder="29042"
                                />
                                <p class="text-xs text-gray-500 mt-1" data-i18n="travelers.municipalityHelp">
                                    Ejemplo: 29042 (Fuengirola), 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)<br>
                                    <strong>IMPORTANTE:</strong> Este NO es el c√≥digo postal, sino el c√≥digo INE del municipio (5 d√≠gitos: 2 de provincia + 3 de municipio)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensajes de estado -->
                <div id="successMessage" class="success-message">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">
                                <strong data-i18n="messages.success.title">¬°Registro enviado correctamente!</strong> 
                                <span data-i18n="messages.success.body">Los datos han sido enviados al dashboard del administrador.</span>
                            </p>
                            <p class="text-sm mt-1" data-i18n="messages.success.redirect">
                                Ser√° redirigido al dashboard en unos segundos...
                            </p>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="error-message">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">
                                <strong data-i18n="messages.error.title">Error al enviar el registro.</strong> 
                                <span id="errorDetails" data-i18n="messages.error.body">Por favor, int√©ntelo de nuevo.</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de env√≠o -->
                <div class="pt-6">
                    <button
                        type="submit"
                        id="submitButton"
                        class="btn-primary w-full flex items-center justify-center text-lg"
                    >
                        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span data-i18n="submit.button">Enviar Registro</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Sistema de traducciones
        const translations = {
            es: {
                "header.title": "Delf√≠n Check-in",
                "header.subtitle": "Sistema de Registro de Viajeros",
                "main.title": "Registro de parte de viajero",
                "main.subtitle": "Compatible con alta en el Ministerio del Interior de Espa√±a",
                "main.required": "Complete todos los campos obligatorios marcados con *",
                "contract.title": "Contrato",
                "contract.establishmentCode": "C√≥digo establecimiento *",
                "contract.reference": "Referencia *",
                "contract.contractDate": "Fecha contrato (AAAA-MM-DD) *",
                "contract.checkIn": "Entrada (AAAA-MM-DDThh:mm:ss) *",
                "contract.checkOut": "Salida (AAAA-MM-DDThh:mm:ss) *",
                "contract.rooms": "N¬∫ habitaciones",
                "contract.internet": "Internet",
                "contract.paymentType": "Tipo de pago *",
                "contract.payment.cash": "Efectivo",
                "contract.payment.card": "Tarjeta",
                "contract.payment.platform": "Plataforma",
                "contract.payment.transfer": "Transferencia",
                "contract.payment.mobile": "M√≥vil",
                "contract.payment.check": "Cheque",
                "contract.payment.destination": "Destino",
                "contract.payment.other": "Otro",
                "contract.paymentDate": "Fecha de pago (AAAA-MM-DD)",
                "contract.paymentMethod": "Medio de pago",
                "contract.cardholder": "Titular",
                "contract.expiry": "Caducidad (MM/AAAA)",
                "travelers.title": "Viajeros",
                "travelers.traveler1": "Viajero 1",
                "travelers.firstName": "Nombre *",
                "travelers.firstSurname": "Primer apellido *",
                "travelers.secondSurname": "Segundo apellido",
                "travelers.birthDate": "Fecha nacimiento (AAAA-MM-DD) *",
                "travelers.documentType": "Tipo documento",
                "travelers.documents.dni": "DNI",
                "travelers.documents.nie": "NIE",
                "travelers.documents.passport": "Pasaporte",
                "travelers.documents.other": "Otro",
                "travelers.documentNumber": "N√∫mero documento",
                "travelers.nationality": "Nacionalidad (ISO3)",
                "travelers.gender": "Sexo",
                "travelers.gender.male": "Hombre",
                "travelers.gender.female": "Mujer",
                "travelers.gender.other": "Otro",
                "travelers.phone": "Tel√©fono",
                "travelers.email": "Correo electr√≥nico",
                "travelers.address": "Direcci√≥n *",
                "travelers.postalCode": "C√≥digo postal *",
                "travelers.country": "Pa√≠s (ISO3) *",
                "travelers.countries.spain": "Espa√±a",
                "travelers.countries.france": "Francia",
                "travelers.countries.uk": "Reino Unido",
                "travelers.countries.germany": "Alemania",
                "travelers.countries.italy": "Italia",
                "travelers.countries.portugal": "Portugal",
                "travelers.municipalityCode": "C√≥digo municipio INE (5) *",
                "travelers.municipalityHelp": "Ejemplo: 29042 (Fuengirola), 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)<br><strong>IMPORTANTE:</strong> Este NO es el c√≥digo postal, sino el c√≥digo INE del municipio (5 d√≠gitos: 2 de provincia + 3 de municipio)",
                "messages.success.title": "¬°Registro enviado correctamente!",
                "messages.success.body": "Los datos han sido enviados al dashboard del administrador.",
                "messages.success.redirect": "Ser√° redirigido al dashboard en unos segundos...",
                "messages.error.title": "Error al enviar el registro.",
                "messages.error.body": "Por favor, int√©ntelo de nuevo.",
                "submit.button": "Enviar Registro",
                "submit.sending": "Enviando..."
            },
            en: {
                "header.title": "Delf√≠n Check-in",
                "header.subtitle": "Guest Registration System",
                "main.title": "Traveler Registration Form",
                "main.subtitle": "Compatible with Spanish Ministry of Interior registration",
                "main.required": "Complete all required fields marked with *",
                "contract.title": "Contract",
                "contract.establishmentCode": "Establishment code *",
                "contract.reference": "Reference *",
                "contract.contractDate": "Contract date (YYYY-MM-DD) *",
                "contract.checkIn": "Check-in (YYYY-MM-DDThh:mm:ss) *",
                "contract.checkOut": "Check-out (YYYY-MM-DDThh:mm:ss) *",
                "contract.rooms": "Number of rooms",
                "contract.internet": "Internet",
                "contract.paymentType": "Payment type *",
                "contract.payment.cash": "Cash",
                "contract.payment.card": "Card",
                "contract.payment.platform": "Platform",
                "contract.payment.transfer": "Transfer",
                "contract.payment.mobile": "Mobile",
                "contract.payment.check": "Check",
                "contract.payment.destination": "Destination",
                "contract.payment.other": "Other",
                "contract.paymentDate": "Payment date (YYYY-MM-DD)",
                "contract.paymentMethod": "Payment method",
                "contract.cardholder": "Cardholder",
                "contract.expiry": "Expiry (MM/YYYY)",
                "travelers.title": "Travelers",
                "travelers.traveler1": "Traveler 1",
                "travelers.firstName": "First name *",
                "travelers.firstSurname": "First surname *",
                "travelers.secondSurname": "Second surname",
                "travelers.birthDate": "Birth date (YYYY-MM-DD) *",
                "travelers.documentType": "Document type",
                "travelers.documents.dni": "DNI",
                "travelers.documents.nie": "NIE",
                "travelers.documents.passport": "Passport",
                "travelers.documents.other": "Other",
                "travelers.documentNumber": "Document number",
                "travelers.nationality": "Nationality (ISO3)",
                "travelers.gender": "Gender",
                "travelers.gender.male": "Male",
                "travelers.gender.female": "Female",
                "travelers.gender.other": "Other",
                "travelers.phone": "Phone",
                "travelers.email": "Email",
                "travelers.address": "Address *",
                "travelers.postalCode": "Postal code *",
                "travelers.country": "Country (ISO3) *",
                "travelers.countries.spain": "Spain",
                "travelers.countries.france": "France",
                "travelers.countries.uk": "United Kingdom",
                "travelers.countries.germany": "Germany",
                "travelers.countries.italy": "Italy",
                "travelers.countries.portugal": "Portugal",
                "travelers.municipalityCode": "Municipality INE code (5) *",
                "travelers.municipalityHelp": "Example: 29042 (Fuengirola), 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)<br><strong>IMPORTANT:</strong> This is NOT the postal code, but the INE municipality code (5 digits: 2 for province + 3 for municipality)",
                "messages.success.title": "Registration sent successfully!",
                "messages.success.body": "Data has been sent to the admin dashboard.",
                "messages.success.redirect": "You will be redirected to the dashboard in a few seconds...",
                "messages.error.title": "Error sending registration.",
                "messages.error.body": "Please try again.",
                "submit.button": "Send Registration",
                "submit.sending": "Sending..."
            },
            fr: {
                "header.title": "Delf√≠n Check-in",
                "header.subtitle": "Syst√®me d'Enregistrement des Voyageurs",
                "main.title": "Formulaire d'Enregistrement des Voyageurs",
                "main.subtitle": "Compatible avec l'enregistrement du Minist√®re de l'Int√©rieur espagnol",
                "main.required": "Remplissez tous les champs obligatoires marqu√©s avec *",
                "contract.title": "Contrat",
                "contract.establishmentCode": "Code √©tablissement *",
                "contract.reference": "R√©f√©rence *",
                "contract.contractDate": "Date contrat (AAAA-MM-JJ) *",
                "contract.checkIn": "Arriv√©e (AAAA-MM-JJThh:mm:ss) *",
                "contract.checkOut": "D√©part (AAAA-MM-JJThh:mm:ss) *",
                "contract.rooms": "Nombre de chambres",
                "contract.internet": "Internet",
                "contract.paymentType": "Type de paiement *",
                "contract.payment.cash": "Esp√®ces",
                "contract.payment.card": "Carte",
                "contract.payment.platform": "Plateforme",
                "contract.payment.transfer": "Virement",
                "contract.payment.mobile": "Mobile",
                "contract.payment.check": "Ch√®que",
                "contract.payment.destination": "Destination",
                "contract.payment.other": "Autre",
                "contract.paymentDate": "Date de paiement (AAAA-MM-JJ)",
                "contract.paymentMethod": "Moyen de paiement",
                "contract.cardholder": "Titulaire",
                "contract.expiry": "Expiration (MM/AAAA)",
                "travelers.title": "Voyageurs",
                "travelers.traveler1": "Voyageur 1",
                "travelers.firstName": "Pr√©nom *",
                "travelers.firstSurname": "Premier nom de famille *",
                "travelers.secondSurname": "Deuxi√®me nom de famille",
                "travelers.birthDate": "Date de naissance (AAAA-MM-JJ) *",
                "travelers.documentType": "Type de document",
                "travelers.documents.dni": "DNI",
                "travelers.documents.nie": "NIE",
                "travelers.documents.passport": "Passeport",
                "travelers.documents.other": "Autre",
                "travelers.documentNumber": "Num√©ro de document",
                "travelers.nationality": "Nationalit√© (ISO3)",
                "travelers.gender": "Sexe",
                "travelers.gender.male": "Homme",
                "travelers.gender.female": "Femme",
                "travelers.gender.other": "Autre",
                "travelers.phone": "T√©l√©phone",
                "travelers.email": "Email",
                "travelers.address": "Adresse *",
                "travelers.postalCode": "Code postal *",
                "travelers.country": "Pays (ISO3) *",
                "travelers.countries.spain": "Espagne",
                "travelers.countries.france": "France",
                "travelers.countries.uk": "Royaume-Uni",
                "travelers.countries.germany": "Allemagne",
                "travelers.countries.italy": "Italie",
                "travelers.countries.portugal": "Portugal",
                "travelers.municipalityCode": "Code municipal INE (5) *",
                "travelers.municipalityHelp": "Exemple: 29042 (Fuengirola), 29045 (M√°laga), 28001 (Madrid), 08001 (Barcelona)<br><strong>IMPORTANT:</strong> Ceci n'est PAS le code postal, mais le code INE de la municipalit√© (5 chiffres: 2 pour la province + 3 pour la municipalit√©)",
                "messages.success.title": "Enregistrement envoy√© avec succ√®s !",
                "messages.success.body": "Les donn√©es ont √©t√© envoy√©es au tableau de bord administrateur.",
                "messages.success.redirect": "Vous serez redirig√© vers le tableau de bord dans quelques secondes...",
                "messages.error.title": "Erreur lors de l'envoi de l'enregistrement.",
                "messages.error.body": "Veuillez r√©essayer.",
                "submit.button": "Envoyer l'Enregistrement",
                "submit.sending": "Envoi en cours..."
            }
        };

        // Funci√≥n para cambiar idioma
        function changeLanguage(lang) {
            // Actualizar botones de idioma
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
            
            // Cambiar atributo lang del HTML
            document.documentElement.lang = lang;
            
            // Aplicar traducciones
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Guardar preferencia en localStorage
            localStorage.setItem('preferredLanguage', lang);
        }

        // Funci√≥n para inicializar idioma
        function initializeLanguage() {
            const savedLang = localStorage.getItem('preferredLanguage') || 'es';
            changeLanguage(savedLang);
        }

        // Inicializar idioma al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeLanguage();
            
            // Detectar si se est√° usando file:// y mostrar aviso
            if (window.location.protocol === 'file:') {
                const warning = document.getElementById('fileProtocolWarning');
                if (warning) {
                    warning.classList.remove('hidden');
                }
            }
        });

        // Helpers: limpiar payload y validaciones m√≠nimas
        function cleanEmpty(value) {
            if (Array.isArray(value)) {
                const arr = value.map(cleanEmpty).filter(v => {
                    if (v == null) return false;
                    if (typeof v === 'string' && v.trim() === '') return false;
                    if (typeof v === 'object' && !Array.isArray(v) && Object.keys(v).length === 0) return false;
                    return true;
                });
                return arr;
            }
            if (value && typeof value === 'object') {
                const out = {};
                for (const [k, v] of Object.entries(value)) {
                    const c = cleanEmpty(v);
                    if (c == null) continue;
                    if (typeof c === 'string' && c.trim() === '') continue;
                    if (typeof c === 'object' && !Array.isArray(c) && Object.keys(c).length === 0) continue;
                    out[k] = c;
                }
                return out;
            }
            return value;
        }

        function isFiveDigits(str) {
            return /^\d{5}$/.test(String(str || ''));
        }

        function ensureSeconds(dateStr) {
            if (!dateStr) return '';
            // Si ya est√° en YYYY-MM-DDThh:mm:ss lo dejamos tal cual
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            // Si viene en YYYY-MM-DDThh:mm (sin segundos), a√±adimos :00
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dateStr)) {
                return dateStr + ':00';
            }
            // Cualquier otro caso, lo devolvemos como venga
            return dateStr;
        }

        function formatDateForMIR(dateStr) {
            if (!dateStr) return '';
            // Asegurar formato AAAA-MM-DD para fechas simples
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            // Para fechas con hora, asegurar formato AAAA-MM-DDThh:mm:ss
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(dateStr)) {
                return ensureSeconds(dateStr);
            }
            return dateStr;
        }

        function pad5(str) {
            const digits = String(str || '').replace(/\D/g, '');
            return digits.padStart(5, '0').slice(0, 5);
        }

        function upper3(str) {
            return String(str || '').toUpperCase().slice(0, 3);
        }

        // ---- Validaciones extra robustas MIR ----
        function showError(msg) {
            const errorDetails = document.getElementById('errorDetails');
            if (errorDetails) errorDetails.textContent = msg;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Aviso si se abre como archivo local (file://) ‚Äî esto rompe CORS y produce "Failed to fetch"
        (function() {
            try {
                if (window.location.protocol === 'file:') {
                    showError('Est√°s abriendo el formulario como archivo local (file://). Para poder enviar el registro, sirve esta p√°gina desde https o localhost y a√±ade CORS en el backend (OPTIONS con Access-Control-Allow-*)');
                    console.warn('[Delf√≠n Check-in] Abierto con file:// ‚Äî El navegador bloquear√° el preflight CORS.');
                }
            } catch (_) {}
        })();

        function parseDateOnly(d) {
            // d in YYYY-MM-DD
            if (!d) return null;
            const [y,m,dd] = d.split('-').map(Number);
            if (!y || !m || !dd) return null;
            return new Date(y, m - 1, dd, 0, 0, 0, 0);
        }
        function parseDateTime(dt) {
            // dt in YYYY-MM-DDThh:mm[:ss]
            if (!dt) return null;
            const withSec = ensureSeconds(dt);
            const [date, time] = withSec.split('T');
            const [y,m,dd] = date.split('-').map(Number);
            const [hh,mm,ss] = time.split(':').map(Number);
            return new Date(y, m - 1, dd, hh, mm, ss || 0, 0);
        }
        function validateDateOrder({fechaContrato, fechaEntrada, fechaSalida, fechaNacimiento, fechaPago}) {
            const dContrato = parseDateOnly(fechaContrato);
            const dEntrada = parseDateTime(fechaEntrada);
            const dSalida  = parseDateTime(fechaSalida);
            const dNacimiento = parseDateOnly(fechaNacimiento);
            const dPago = fechaPago ? parseDateOnly(fechaPago) : null;

            if (!dEntrada || !dSalida) return 'Fechas de entrada y salida son obligatorias';
            if (dContrato && dEntrada && dContrato > dEntrada) return 'La fecha de contrato no puede ser posterior a la entrada';
            if (dEntrada && dSalida && dEntrada > dSalida) return 'La fecha de entrada no puede ser posterior a la salida';
            if (dNacimiento && dEntrada && dNacimiento > dEntrada) return 'La fecha de nacimiento no puede ser posterior a la fecha de entrada';
            if (dPago && dSalida && dPago > dSalida) return 'La fecha de pago no puede ser posterior a la salida';
            return null;
        }
        function validateDoc(tipo, numero) {
            if (!tipo && !numero) return null; // ambos vac√≠os, permitido
            if (tipo && !numero) return 'Si selecciona tipo de documento, debe proporcionar el n√∫mero';
            const n = String(numero).trim();
            if (!n) return 'El n√∫mero de documento no puede estar vac√≠o';
            // Reglas m√≠nimas por tipo
            if (tipo === 'NIF') {
                if (!/^\d{7,8}[A-Za-z]$/.test(n)) return 'Formato de NIF inv√°lido (7-8 d√≠gitos + letra)';
            } else if (tipo === 'NIE') {
                if (!/^[XYZxyz]\d{7}[A-Za-z]$/.test(n)) return 'Formato de NIE inv√°lido (X/Y/Z + 7 d√≠gitos + letra)';
            } else if (tipo === 'PAS') {
                if (!/^[A-Za-z0-9]{3,15}$/.test(n)) return 'Pasaporte inv√°lido (3-15 caracteres alfanum√©ricos)';
            }
            return null;
        }
        function sameProvince(cp, ine) {
            return String(cp || '').slice(0,2) === String(ine || '').slice(0,2);
        }
        function validateMunicipioVsCP(cp, ine) {
            if (!isFiveDigits(cp)) return 'C√≥digo postal debe tener 5 d√≠gitos';
            if (!isFiveDigits(ine)) return 'C√≥digo INE del municipio debe tener 5 d√≠gitos (no es el c√≥digo postal)';
            if (cp === ine) return 'El c√≥digo INE del municipio debe ser diferente al c√≥digo postal';
            if (!sameProvince(cp, ine)) return 'Los dos primeros d√≠gitos del INE deben coincidir con la provincia del c√≥digo postal';
            return null;
        }
        function validateCardExpiry(exp) {
            if (!exp) return null;
            if (!/^(0[1-9]|1[0-2])\/\d{4}$/.test(exp)) return 'Caducidad de tarjeta debe ser MM/AAAA';
            return null;
        }

        document.getElementById('guestRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            // Ocultar mensajes anteriores
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Deshabilitar bot√≥n y mostrar estado de env√≠o
            submitButton.disabled = true;
            const currentLang = document.documentElement.lang || 'es';
            const sendingText = translations[currentLang]['submit.sending'] || 'Enviando...';
            submitButton.innerHTML = `
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div>
                ${sendingText}
            `;
            
            try {
                // Validaciones m√≠nimas requeridas por el MIR
                const formData = new FormData(e.target);
                
                // Normalizar y validar fechas
                const fechaContrato = formatDateForMIR(formData.get('fechaContrato'));
                const fechaEntrada = formatDateForMIR(formData.get('fechaEntrada'));
                const fechaSalida = formatDateForMIR(formData.get('fechaSalida'));
                const fechaPago = formatDateForMIR(formData.get('fechaPago'));

                // --- Validaciones robustas previas ---
                const docErr = validateDoc(formData.get('tipoDocumento'), formData.get('numeroDocumento'));
                if (docErr) { showError(docErr); return; }

                const muniErr = validateMunicipioVsCP(
                    pad5(formData.get('codigoPostal')),
                    pad5(formData.get('codigoMunicipio'))
                );
                if (muniErr) { showError(muniErr); return; }

                const orderErr = validateDateOrder({
                    fechaContrato,
                    fechaEntrada,
                    fechaSalida,
                    fechaNacimiento: formData.get('fechaNacimiento'),
                    fechaPago
                });
                if (orderErr) { showError(orderErr); return; }

                const cardErr = validateCardExpiry(formData.get('caducidadTarjeta'));
                if (cardErr) { showError(cardErr); return; }

                // Construcci√≥n del payload cumpliendo esquema y sin strings vac√≠os
                const pago = {
                    tipoPago: formData.get('tipoPago')
                };
                if (fechaPago) pago.fechaPago = fechaPago;
                if (formData.get('medioPago')) pago.medioPago = formData.get('medioPago');
                if (formData.get('titular')) pago.titular = formData.get('titular');
                if (formData.get('caducidadTarjeta')) pago.caducidadTarjeta = formData.get('caducidadTarjeta');

                const persona = {
                    rol: 'VI',
                    nombre: formData.get('nombre'),
                    apellido1: formData.get('apellido1'),
                    apellido2: formData.get('apellido2') || undefined,
                    tipoDocumento: formData.get('tipoDocumento') || undefined,
                    numeroDocumento: formData.get('numeroDocumento') || undefined,
                    // soporteDocumento SOLO si aplica (no enviar si vac√≠o)
                    fechaNacimiento: formData.get('fechaNacimiento'),
                    nacionalidad: upper3(formData.get('nacionalidad')) || undefined,
                    sexo: formData.get('sexo') || undefined,
                    contacto: {
                        telefono: formData.get('telefono') || undefined,
                        telefono2: undefined,
                        correo: formData.get('correo') || undefined
                    },
                    direccion: {
                        direccion: formData.get('direccion'),
                        direccionComplementaria: undefined,
                        codigoPostal: pad5(formData.get('codigoPostal')),
                        pais: upper3(formData.get('pais') || 'ESP'),
                        codigoMunicipio: pad5(formData.get('codigoMunicipio')) || undefined,
                        nombreMunicipio: undefined
                    }
                };

                const data = {
                    codigoEstablecimiento: formData.get('codigoEstablecimiento'),
                    comunicaciones: [
                        {
                            contrato: {
                                referencia: formData.get('referencia'),
                                fechaContrato: fechaContrato,
                                fechaEntrada: fechaEntrada,
                                fechaSalida: fechaSalida,
                                numPersonas: 1,
                                numHabitaciones: parseInt(formData.get('numHabitaciones')) || 1,
                                // solo enviamos si est√° marcado
                                ...(formData.get('internet') === 'on' ? { internet: true } : {}),
                                pago
                            },
                            personas: [persona]
                        }
                    ]
                };
                
                // Limpiar payload y mostrar para debug
                const cleanData = cleanEmpty(data);
                // (Optional debug a solo cliente)
                console.log('üßæ FormData bruta:', Object.fromEntries(formData.entries()));
                console.log('üì§ Payload limpio enviado:', JSON.stringify(cleanData, null, 2));
                
                // Enviar datos a la API de Vercel
                const response = await fetch('https://admin.delfincheckin.com/api/public/guest-registration', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(cleanData),
                });
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    try {
                        const ct = response.headers.get('content-type') || '';
                        if (ct.includes('application/json')) {
                            const errorData = await response.json();
                            if (errorData) {
                                if (errorData.details && Array.isArray(errorData.details) && errorData.details.length) {
                                    errorMessage = errorData.details[0].message || JSON.stringify(errorData.details[0]);
                                } else if (errorData.errors && Array.isArray(errorData.errors) && errorData.errors.length) {
                                    errorMessage = errorData.errors[0].message || JSON.stringify(errorData.errors[0]);
                                } else if (errorData.message) {
                                    errorMessage = errorData.message;
                                } else if (errorData.error) {
                                    errorMessage = errorData.error;
                                } else {
                                    errorMessage = JSON.stringify(errorData);
                                }
                            }
                        } else {
                            const txt = await response.text();
                            if (txt) errorMessage = txt;
                        }
                    } catch (_) {}
                    throw new Error(errorMessage);
                }
                
                // Mostrar mensaje de √©xito
                successMessage.style.display = 'block';
                
                // Redirigir al dashboard despu√©s de 3 segundos
                setTimeout(() => {
                    window.open('https://admin.delfincheckin.com/guest-registrations-dashboard', '_blank');
                }, 3000);
                
            } catch (error) {
                console.error('Error:', error);
                let msg = error && error.message ? String(error.message) : 'Error desconocido';
                if (/fecha|date|datetime/i.test(msg)) {
                    msg += ' ¬∑ Revisa formatos: contrato YYYY-MM-DD, entrada/salida YYYY-MM-DDThh:mm:ss.';
                }
                if (/municipio|postal|\bINE\b/i.test(msg)) {
                    msg += ' ¬∑ Recuerda: INE (5 d√≠gitos) debe ser distinto al CP y compartir provincia (dos primeros d√≠gitos).';
                }
                showError(msg);
            } finally {
                // Restaurar bot√≥n
                submitButton.disabled = false;
                const currentLang = document.documentElement.lang || 'es';
                const buttonText = translations[currentLang]['submit.button'] || 'Enviar Registro';
                submitButton.innerHTML = `
                    <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    ${buttonText}
                `;
            }
        });
    </script>
</body>
</html>
